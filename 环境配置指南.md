# 环境配置指南

## 问题诊断

你遇到的两个阻断性错误已通过以下方式解决：

### 错误 1：PyArmor 运行时不兼容
- **原因**：项目使用 PyArmor 加密，仅支持 Python 3.10/3.11，无法在 Python 3.14 运行
- **解决方案**：使用 `setup_py311_env.bat` 创建 Python 3.11 虚拟环境

### 错误 2：OPENAI_API_KEY 未设置
- **原因**：环境变量未正确导出到 shell
- **解决方案**：使用 `load_env.ps1` 从 `.env` 文件加载环境变量

## 快速开始（3 步）

### 1️⃣ 创建 Python 3.11 环境

双击运行：
```
setup_py311_env.bat
```

这会自动：
- 检查 Python 3.11 安装
- 创建 `.venv311` 虚拟环境  
- 安装所有依赖包

### 2️⃣ 创建 .env 配置文件

在项目根目录创建 `.env` 文件（注意：此文件不会被提交到 Git）

**最小配置（必填）：**
```env
# OpenAI API Key
CLQ_TA_API_KEY=sk-your-openai-api-key-here
OPENAI_API_KEY=${CLQ_TA_API_KEY}

# Market Data 工厂
CLQ_MKD_FACTORY=chanlun_quant.integration.market_data:make_market_datas
```

**完整配置（推荐）：**
```env
# TradingAgents LLM 配置
CLQ_TA_API_KEY=sk-your-openai-api-key-here
OPENAI_API_KEY=${CLQ_TA_API_KEY}
CLQ_TA_MODEL=gpt-4o-mini
CLQ_TA_BASE_URL=https://api.openai.com/v1

# 数据源配置
CLQ_MKD_FACTORY=chanlun_quant.integration.market_data:make_market_datas

# 选股参数
CLQ_FREQ=d
CLQ_MAX_CANDIDATES=80
CLQ_TOP_K=2
CLQ_MIN_SCORE=0.0
CLQ_SAVE_CSV=1

# 日志级别
CLQ_LOG_LEVEL=INFO

# Python 编码
PYTHONIOENCODING=utf-8
PYTHONUTF8=1
```

### 3️⃣ 运行选股脚本

#### 方法 A：PowerShell 一键运行（推荐）✅

```powershell
.\run_ta_selector.ps1
```

自定义参数：
```powershell
# 周线，100个候选，选5个，保存CSV
.\run_ta_selector.ps1 -Freq w -MaxCandidates 100 -TopK 5 -SaveCsv

# 回测模式（指定截止日期）
.\run_ta_selector.ps1 -Freq d -MaxCandidates 40 -TopK 2 -AsOf "2025-10-22"
```

#### 方法 B：批处理运行

双击运行：
```
run_ta_selector.bat
```

或命令行：
```batch
run_ta_selector.bat --freq d --max-candidates 40 --top-k 2 --save-csv
```

#### 方法 C：手动运行（调试用）

```powershell
# 1. 激活虚拟环境
.\.venv311\Scripts\Activate.ps1

# 2. 加载环境变量
. .\load_env.ps1

# 3. 设置 PYTHONPATH
$env:PYTHONPATH = "F:\Cursor\chanlun\src"

# 4. 运行脚本
python examples\wire_ta_selector.py --freq d --max-candidates 40 --top-k 2
```

## 参数说明

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `-Freq` / `--freq` | 分析周期 | `d` | `d`, `w`, `30m` |
| `-MaxCandidates` / `--max-candidates` | 候选池最大数量 | `40` | `80`, `100` |
| `-TopK` / `--top-k` | 最终锁定标的数量 | `2` | `5`, `10` |
| `-AsOf` / `--as-of` | 回测截止日期 | 最新 | `2025-10-22` |
| `-SaveCsv` / `--save-csv` | 保存CSV结果 | `False` | 启用 |

## 常见问题

### ❌ 找不到 Python 3.11

**解决方案：**
1. 访问 https://www.python.org/downloads/
2. 下载 Python 3.11.9（推荐）
3. 安装时勾选 "Add Python to PATH"

或使用 uv 安装：
```batch
script\bin\uv.exe python install 3.11
```

### ❌ OPENAI_API_KEY 未设置

**检查清单：**
1. 确认 `.env` 文件存在
2. 确认 `CLQ_TA_API_KEY` 和 `OPENAI_API_KEY` 都已设置
3. PowerShell 运行 `. .\load_env.ps1` 重新加载

验证：
```powershell
$env:OPENAI_API_KEY  # 应该显示你的 API Key
```

### ❌ 提示找不到 chanlun 模块

**解决方案：**
确保 `PYTHONPATH` 已设置：

```powershell
$env:PYTHONPATH = "F:\Cursor\chanlun\src"
```

或在脚本中已自动设置（使用 `run_ta_selector.ps1` 会自动处理）

### ❌ PyArmor 运行时错误

**原因：**
Python 版本不兼容（必须是 3.10 或 3.11）

**检查当前版本：**
```batch
.venv311\Scripts\python.exe --version
```

应该显示 `Python 3.11.x` 或 `Python 3.10.x`

### ❌ IB 连接失败

**前置条件：**
1. IB Gateway 已启动
2. Redis 服务已启动
3. IB Worker 已启动

启动 IB Worker：
```batch
start_ib_tasks.bat
```

## 工具文件说明

| 文件 | 用途 |
|------|------|
| `setup_py311_env.bat` | 创建 Python 3.11 虚拟环境（一次性） |
| `load_env.ps1` | 从 .env 加载环境变量到 PowerShell |
| `run_ta_selector.ps1` | PowerShell 运行脚本（推荐） |
| `run_ta_selector.bat` | 批处理运行脚本 |
| `QUICKSTART.md` | 详细快速启动指南 |
| `环境配置指南.md` | 本文档 |
| `.env` | 环境变量配置（需手动创建） |

## 下一步

1. ✅ Python 3.11 环境已创建
2. ✅ .env 文件已配置
3. ✅ 可以运行选股脚本

**开始选股：**
```powershell
.\run_ta_selector.ps1
```

**查看完整文档：**
```
QUICKSTART.md
```

**调试模式：**
在 `.env` 中设置：
```env
CLQ_LOG_LEVEL=DEBUG
```

祝交易顺利！📈

