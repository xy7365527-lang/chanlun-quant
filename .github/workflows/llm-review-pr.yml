name: LLMä»£ç å®¡æŸ¥ï¼ˆPRï¼‰
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests

      - name: è·å–PRå·®å¼‚
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          git diff --unified=3 origin/${{ github.base_ref }}...HEAD > pr.diff
          echo "å·®å¼‚æ–‡ä»¶å¤§å°: $(wc -c < pr.diff) å­—èŠ‚"

      - name: LLMå®¡æŸ¥ä»£ç 
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: python
        run: |
          import json
          import os
          import requests
          import sys
          from pathlib import Path

          diff_path = Path("pr.diff")
          try:
              diff = diff_path.read_text(encoding="utf-8")[:150000]
          except Exception as exc:
              print(f"âŒ è¯»å–diffå¤±è´¥: {exc}")
              sys.exit(0)

          if not diff.strip():
              print("â„¹ï¸ æ— ä»£ç å˜æ›´ï¼Œè·³è¿‡å®¡æŸ¥")
              sys.exit(0)

          prompt = f"""ä½ æ˜¯ä¸€ä½èµ„æ·±çš„Pythonä»£ç å®¡æŸ¥ä¸“å®¶ï¼Œä¸“æ³¨äºé‡åŒ–äº¤æ˜“ç³»ç»Ÿçš„ä»£ç è´¨é‡ã€‚

è¯·å¯¹ä»¥ä¸‹Git diffè¿›è¡Œå…¨é¢å®¡æŸ¥ï¼Œé‡ç‚¹å…³æ³¨ï¼š

## å®¡æŸ¥ç»´åº¦
1. **å®‰å…¨æ€§ä¸è¾¹ç•Œæ¡ä»¶**
   - æ•°å€¼è®¡ç®—æ˜¯å¦æœ‰é™¤é›¶ã€æº¢å‡ºé£é™©
   - æ•°ç»„ç´¢å¼•æ˜¯å¦å¯èƒ½è¶Šç•Œ
   - ç©ºå€¼/Noneçš„å¤„ç†æ˜¯å¦å®Œå–„

2. **ä»£ç è´¨é‡**
   - å¤æ‚åº¦æ˜¯å¦è¿‡é«˜
   - å‘½åæ˜¯å¦æ¸…æ™°
   - æ˜¯å¦æœ‰é‡å¤ä»£ç 

3. **æ½œåœ¨Bug**
   - é€»è¾‘é”™è¯¯
   - ç±»å‹ä¸åŒ¹é…
   - èµ„æºæ³„æ¼

4. **æ€§èƒ½ä¸ä¼˜åŒ–**
   - æ˜¯å¦æœ‰ä¸å¿…è¦çš„å¾ªç¯æˆ–è®¡ç®—
   - æ•°æ®ç»“æ„é€‰æ‹©æ˜¯å¦åˆç†

5. **æµ‹è¯•è¦†ç›–**
   - æ˜¯å¦éœ€è¦è¡¥å……æµ‹è¯•ç”¨ä¾‹
   - è¾¹ç•Œæ¡ä»¶æ˜¯å¦æœ‰æµ‹è¯•

## è¾“å‡ºæ ¼å¼
è¯·ç”¨ä¸­æ–‡è¾“å‡ºï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

### âœ… å®¡æŸ¥é€šè¿‡çš„éƒ¨åˆ†
- [ç®€è¦è¯´æ˜å¥½çš„å®è·µ]

### âš ï¸ éœ€è¦æ³¨æ„çš„é—®é¢˜
**æ–‡ä»¶: `è·¯å¾„/æ–‡ä»¶å.py`**
- è¡Œ X: [å…·ä½“é—®é¢˜æè¿°]
  - å»ºè®®: [æ”¹è¿›å»ºè®®]

### ğŸ”§ å¯é€‰ä¼˜åŒ–å»ºè®®
- [æ€§èƒ½æˆ–ä»£ç è´¨é‡æ”¹è¿›å»ºè®®]

## DIFFå†…å®¹
```diff
{diff}
```
"""

          api_key = os.environ.get("OPENAI_API_KEY")
          if not api_key:
              print("âŒ æœªè®¾ç½® OPENAI_API_KEY")
              sys.exit(0)

          try:
              response = requests.post(
                  "https://api.openai.com/v1/chat/completions",
                  headers={
                      "Authorization": f"Bearer {api_key}",
                      "Content-Type": "application/json",
                  },
                  json={
                      "model": "gpt-4",
                      "messages": [
                          {"role": "system", "content": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä»£ç å®¡æŸ¥ä¸“å®¶ï¼Œä¸“æ³¨äºPythoné‡åŒ–äº¤æ˜“ç³»ç»Ÿã€‚"},
                          {"role": "user", "content": prompt},
                      ],
                      "temperature": 0.2,
                      "max_tokens": 4000,
                  },
                  timeout=60,
              )
              response.raise_for_status()

              review_content = response.json()["choices"][0]["message"]["content"]
              Path("review_result.txt").write_text(review_content, encoding="utf-8")
              print("âœ… å®¡æŸ¥å®Œæˆ")
              print(review_content[:500])

          except requests.exceptions.RequestException as exc:
              print(f"âŒ APIè¯·æ±‚å¤±è´¥: {exc}")
              Path("review_result.txt").write_text(
                  "âš ï¸ LLMå®¡æŸ¥æœåŠ¡æš‚æ—¶ä¸å¯ç”¨: " + str(exc) + "\n\nè¯·äººå·¥å®¡æŸ¥ä»£ç å˜æ›´ã€‚",
                  encoding="utf-8",
              )
          except Exception as exc:
              print(f"âŒ å®¡æŸ¥è¿‡ç¨‹å‡ºé”™: {exc}")
              Path("review_result.txt").write_text(
                  "âš ï¸ å®¡æŸ¥è¿‡ç¨‹å‡ºé”™: " + str(exc),
                  encoding="utf-8",
              )

      - name: å‘å¸ƒå®¡æŸ¥ç»“æœåˆ°PR
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f review_result.txt ]; then
            TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
            {
              printf '## ğŸ¤– AIä»£ç å®¡æŸ¥ç»“æœ\n\n'
              cat review_result.txt
              printf '\n\n---\n*ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*\n*å®¡æŸ¥æ—¶é—´: %s*\n' "$TIMESTAMP"
            } > review_comment.md
            gh pr comment ${{ github.event.pull_request.number }} --body-file review_comment.md
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å®¡æŸ¥ç»“æœæ–‡ä»¶"
          fi

