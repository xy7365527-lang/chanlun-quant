name: LLM‰ª£Á†ÅÂÆ°Êü•ÔºàPushÔºâ
on:
  push:
    branches:
      - master
      - main
      - develop

permissions:
  contents: read
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Ëé∑ÂèñÊúÄËøë‰∏§Ê¨°Êèê‰∫§‰ª•ËøõË°ådiff

      - name: ËÆæÁΩÆPythonÁéØÂ¢É
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ÂÆâË£Ö‰æùËµñ
        run: |
          pip install requests

      - name: Ëé∑ÂèñÊèê‰∫§Â∑ÆÂºÇ
        run: |
          # Ëé∑ÂèñÊú¨Ê¨°Êèê‰∫§‰∏é‰∏äÊ¨°Êèê‰∫§ÁöÑÂ∑ÆÂºÇ
          git diff HEAD~1 HEAD > commit.diff
          echo "Â∑ÆÂºÇÊñá‰ª∂Â§ßÂ∞è: $(wc -c < commit.diff) Â≠óËäÇ"
          
          # Ëé∑ÂèñÊèê‰∫§‰ø°ÊÅØ
          git log -1 --pretty=format:"Êèê‰∫§: %h%n‰ΩúËÄÖ: %an%nÊó∂Èó¥: %ci%nÊ∂àÊÅØ: %s" > commit_info.txt

      - name: LLMÂÆ°Êü•‰ª£Á†Å
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python - << 'PYTHON_SCRIPT'
import os
import json
import requests
import sys

# ËØªÂèñÊèê‰∫§‰ø°ÊÅØ
try:
    with open('commit_info.txt', 'r', encoding='utf-8') as f:
        commit_info = f.read()
except Exception:
    commit_info = "Êó†Ê≥ïËé∑ÂèñÊèê‰∫§‰ø°ÊÅØ"

# ËØªÂèñdiffÊñá‰ª∂
try:
    with open('commit.diff', 'r', encoding='utf-8') as f:
        diff = f.read()[:150000]
except Exception as e:
    print(f"‚ùå ËØªÂèñdiffÂ§±Ë¥•: {e}")
    sys.exit(0)

if not diff.strip():
    print("‚ÑπÔ∏è Êó†‰ª£Á†ÅÂèòÊõ¥ÔºåË∑≥ËøáÂÆ°Êü•")
    sys.exit(0)

# ÊûÑÂª∫ÂÆ°Êü•ÊèêÁ§∫
prompt = f"""‰Ω†ÊòØ‰∏Ä‰ΩçËµÑÊ∑±ÁöÑPython‰ª£Á†ÅÂÆ°Êü•‰∏ìÂÆ∂Ôºå‰∏ìÊ≥®‰∫éÈáèÂåñ‰∫§ÊòìÁ≥ªÁªüÁöÑ‰ª£Á†ÅË¥®Èáè„ÄÇ

## Êèê‰∫§‰ø°ÊÅØ
{commit_info}

ËØ∑ÂØπ‰ª•‰∏ã‰ª£Á†ÅÂèòÊõ¥ËøõË°åÂø´ÈÄüÂÆ°Êü•ÔºåÈáçÁÇπÂÖ≥Ê≥®Ôºö

1. **‰∏•ÈáçÈóÆÈ¢ò**ÔºàÂøÖÈ°ª‰øÆÂ§çÔºâ
   - ÂÆâÂÖ®ÊºèÊ¥û
   - ÊòéÊòæÁöÑÈÄªËæëÈîôËØØ
   - ÂèØËÉΩÂØºËá¥Á≥ªÁªüÂ¥©Ê∫ÉÁöÑbug

2. **ÈáçË¶ÅÂª∫ËÆÆ**ÔºàÂº∫ÁÉàÂª∫ËÆÆ‰øÆÂ§çÔºâ
   - ÊÄßËÉΩÈóÆÈ¢ò
   - ‰ª£Á†ÅË¥®ÈáèÈóÆÈ¢ò
   - Áº∫Â∞ëÂøÖË¶ÅÁöÑÈîôËØØÂ§ÑÁêÜ

3. **‰ºòÂåñÂª∫ËÆÆ**ÔºàÂèØÈÄâÔºâ
   - ‰ª£Á†ÅÈ£éÊ†ºÊîπËøõ
   - ÂèØËØªÊÄß‰ºòÂåñ

## ËæìÂá∫Ê†ºÂºè
Áî®‰∏≠ÊñáËæìÂá∫ÔºåÊ†ºÂºèÁÆÄÊ¥ÅÔºö

### üö® ‰∏•ÈáçÈóÆÈ¢ò
[Â¶ÇÊûúÊúâÔºåÂàóÂá∫ÔºõÂê¶ÂàôÂÜô"Êó†"]

### ‚ö†Ô∏è ÈáçË¶ÅÂª∫ËÆÆ
[Â¶ÇÊûúÊúâÔºåÂàóÂá∫ÔºõÂê¶ÂàôÂÜô"Êó†"]

### üí° ‰ºòÂåñÂª∫ËÆÆ
[Â¶ÇÊûúÊúâÔºåÁÆÄË¶ÅÂàóÂá∫ÔºõÂê¶ÂàôÂÜô"‰ª£Á†ÅË¥®ÈáèËâØÂ•Ω"]

## DIFFÂÜÖÂÆπ
```diff
{diff}
```
"""

api_key = os.environ.get('OPENAI_API_KEY')
if not api_key:
    print("‚ùå Êú™ËÆæÁΩÆ OPENAI_API_KEY")
    sys.exit(0)

try:
    response = requests.post(
        "https://api.openai.com/v1/chat/completions",
        headers={
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json"
        },
        json={
            "model": "gpt-4",
            "messages": [
                {"role": "system", "content": "‰Ω†ÊòØ‰∏ì‰∏öÁöÑ‰ª£Á†ÅÂÆ°Êü•‰∏ìÂÆ∂ÔºåÊèê‰æõÁÆÄÊ¥ÅÁ≤æÂáÜÁöÑÂÆ°Êü•ÊÑèËßÅ„ÄÇ"},
                {"role": "user", "content": prompt}
            ],
            "temperature": 0.2,
            "max_tokens": 2000
        },
        timeout=60
    )
    response.raise_for_status()
    
    review_content = response.json()["choices"][0]["message"]["content"]
    
    with open('review_result.txt', 'w', encoding='utf-8') as f:
        f.write(review_content)
    
    print("‚úÖ ÂÆ°Êü•ÂÆåÊàê")
    print(review_content)
    
except Exception as e:
    print(f"‚ö†Ô∏è ÂÆ°Êü•Â§±Ë¥•: {e}")
    with open('review_result.txt', 'w', encoding='utf-8') as f:
        f.write(f"‚ö†Ô∏è Ëá™Âä®ÂÆ°Êü•ÊöÇÊó∂‰∏çÂèØÁî®\n\n{commit_info}")

PYTHON_SCRIPT

      - name: ËæìÂá∫ÂÆ°Êü•ÁªìÊûú
        if: always()
        run: |
          if [ -f review_result.txt ]; then
            echo "========== ÂÆ°Êü•ÁªìÊûú =========="
            cat review_result.txt
            echo "=============================="
          fi

      - name: ‰∏ä‰º†ÂÆ°Êü•Êä•Âëä‰∏∫Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-report
          path: |
            review_result.txt
            commit.diff
            commit_info.txt
          retention-days: 30

